<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .sticker {
            box-sizing: border-box;
            position: absolute;
            padding: 10px;
            font: italic 15px Arial;
        }
    </style>
</head>
<body></body>
<script>
		let zIndex = 0;
		let zIndexDrag = 0;
		//Создание textarea
		document.addEventListener('dblclick', function(event) {
			let textarea = document.createElement('textarea');
			//Атрибуты
			textarea.className = 'sticker';
			textarea.id = zIndex;
			textarea.draggable = true;

			//css свойства
			textarea.style.zIndex = ++zIndex;
			textarea.style.left = event.pageX + 'px';
			textarea.style.top = event.pageY + 'px';
			textarea.style.height = 150 + 'px';
			textarea.style.width = 200 + 'px';

			document.body.appendChild(textarea);

			let oldWidth = 200;
			let oldHeight = 150;
			let oldText = '';
			zIndexDrag = zIndex;

			save('update', textarea.outerHTML, 'creat');

			//Изменение размера оббъекта
			textarea.addEventListener('mouseup', function(event)  {
				if (oldWidth !== this.style.width || oldHeight !== this.style.height) {
					if (oldWidth != parseInt(this.style.width)) {
						save('update', this.outerHTML, 'updateWidth');
					}
					if (oldHeight != parseInt(this.style.height)) {
						save('update', this.outerHTML, 'updateHeight');
					}
					oldWidth = this.style.width;
					oldHeight = this.style.height;
				}
					event.preventDefault();
			});

			//Изменение текста внутри объекта
			textarea.addEventListener('change', function(event) {
				if (oldText !== this.value) {
					save('update', this.outerHTML, 'updateText');
				}

				event.preventDefault();
			});

			//Изменение индекса объекта при фокусе
			let oldIndex = textarea.style.zIndex;
			textarea.addEventListener('click', function(event) {
				this.style.zIndex = ++zIndexDrag;
				event.preventDefault();
			})	
			textarea.addEventListener('blur', function(event) {
				this.style.zIndex = oldIndex;
			})


			//Перемещение объекта 
			let textareaMany = document.getElementsByTagName('textarea');
			for (var i = 0; i < textareaMany.length; i++ ) {
				textareaMany[i].addEventListener('dragstart', function(event) {
					 window.correctionX = parseInt(event.pageX) - parseInt(this.style.left);
					 window.correctionY = parseInt(event.pageY) - parseInt(this.style.top);
					 ++zIndexDrag;
				});

				textareaMany[i].addEventListener('dragend', function(event) {
					this.style.left = event.pageX -  window.correctionX + 'px';
					this.style.top = event.pageY -  window.correctionY + 'px';
					this.style.zIndex = zIndexDrag;
					save('update', this.outerHTML, 'Перемещене');
				});

			}
			event.preventDefault();
		});
		
		//Удаление textarea
		document.addEventListener('mousedown', function(event) {
				if (event.which == 2) {
					let textarea = document.getElementById(event.target.id);
					textarea.outerHTML = '';
					save('deleteObject', textarea.id);
					event.preventDefault();
				}
		});

function save(wathChange, change, changes) {
	let conditious = '';
	switch (wathChange) {
		case 'update':
			conditious = 'object=' + change + '&changes=' + changes;
		break;

		case 'deleteObject':
		console.log(change);
			conditious = 'deleteObject=' + change;
		break;
	}

	searchParams = new URLSearchParams( conditious );
	let promise = fetch('ajax.php', {
		method: 'POST',
		body: searchParams
	})
/*
	promise.then(response => {
		return response.text();
	}).then(text => {
		document.write(text);
	})*/
}

</script>
</html>